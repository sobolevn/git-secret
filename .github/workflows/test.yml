name: test

on:
  push:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
  pull_request:
    paths-ignore:
      - 'docs/**'
  workflow_dispatch:

concurrency: 
  group: ${{ github.head_ref || github.run_id }}-test
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Shellcheck and Hadolint
      run: make lint

  docker-ci:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        docker-env:
          - alma
          - alpine
          - arch
          - debian-gnupg1  # We need to test legacy version of gnupg
          - debian-gnupg2
          - fedora
          - rocky
          - ubuntu
    steps:
    - uses: actions/checkout@v3
    - name: Run checks
      run: SECRETS_DOCKER_ENV="${{ matrix.docker-env }}" make docker-ci

  osx-ci:
    runs-on: macos-latest
    strategy:
      matrix:
        test-verbose: [0, 1]
    steps:
    - uses: actions/checkout@v3
    - name: Install deps
      run: brew install gawk gnupg
    - name: Run checks
      run: SECRETS_TEST_VERBOSE=${{ matrix.test-verbose }} make test

  windows-msys2-ci:
    runs-on: windows-latest
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: mingw64
        update: true
        install: >-
          base-devel
          git man make 
    - uses: actions/checkout@v3
    - name: Run checks
      run: make test
      env:
        SECRETS_DOCKER_ENV: windows
        SECRETS_TEST_VERBOSE: 1

  windows-cygwin-ci:
    runs-on: windows-latest
    steps:
    - run: git config --global core.autocrlf input
    - uses: actions/checkout@v3
    - uses: cygwin/cygwin-install-action@master
    - name: Run checks
      run: make test
      env:
        SECRETS_DOCKER_ENV: windows
        SECRETS_TEST_VERBOSE: 1

  windows-wsl-cl:
    runs-on: windows-latest
    steps:
    - name: Run "wsl --install Ubuntu"
      run: wsl --install --distribution Ubuntu
    - name: Run "wsl --list --all"
      run: wsl --list --all
    - name: Run "bash --version"
      run: bash --version
    - name: Run "wsl whoami"
      run: wsl --distribution Ubuntu whoami
    - name: Run "wsl --status"
      run: wsl --status
    - uses: actions/checkout@v3
    - name: Run checks
      run: make test
      env:
        SECRETS_DOCKER_ENV: windows
        SECRETS_TEST_VERBOSE: 1
